# FlashStrike WAL Storage Architecture â€” Overview

The FlashStrike Write-Ahead Log (WAL) provides a **durable, replayable, binary-stable record** of all matching engine events.  
It is designed for:

- **high-throughput write performance**  
- **zero-copy replay**  
- **corruption and tampering detection**  
- **maintaining full event chronology**  

This document provides a high-level overview of the WAL storage model.  
Detailed documentation for each WAL component is linked at the end.

---

# 1. WAL Storage Model

A WAL is composed of **segments**, and each segment is composed of **blocks**.  
This structure supports predictable I/O patterns, fast scanning, and durable event persistence.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        WAL Segment File      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Segment Header (64B)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Block 0 (Header + Events)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Block 1 (Header + Events)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ...                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Each segment:

- stores a **contiguous range of RequestEvents**
- includes **strong integrity metadata**
- is **binary-stable** across FlashStrike versions

---

# 2. WAL Segment Header (64 bytes)

Each segment begins with a fixed-size, cache-line aligned header that provides:

- segment identity  
- event range (first/last ID)  
- block count  
- timestamps (created/closed)  
- strong integrity checksum  
- chained checksum with prior segment  

This enables:

- safe restart/replay  
- fast validation  
- deterministic reconstruction  

ğŸ“„ **Detailed spec:**  
ğŸ‘‰ [`WAL segment header`](./segment/header.md)

---

# 3. WAL Blocks

After the segment header, the file contains a sequence of **fixed-size blocks**.  
Each block stores:

### 1. A 64-byte BlockHeader  
Includes:
- event count  
- block index  
- event ID range  
- XXH64 block checksum  
- chained checksum  
- header checksum  

ğŸ“„ Detailed spec:  
ğŸ‘‰ [`WAL segment block_header`](./segment/block_header.md)

### 2. A fixed array of RequestEvents  
The block payload contains the serialized event stream generated by the matcher.

ğŸ“„ Detailed block documentation:  
ğŸ‘‰ [`WAL segment block`](./segment/block.md)

---

# 4. Checksum System

FlashStrike WAL uses **three layers of checksums** to guarantee replay correctness:

### 1. Block checksum  
Validates event payload only.

### 2. Chained checksum  
Links each block to the previous one, forming a forward-secure chain.

### 3. Header checksum  
Validates the structural metadata of each header.

Together, they provide:

- corruption detection  
- tamper resistance  
- deterministic replay  
- safety against partial writes  

---

# 5. Event Ordering Guarantees

The WAL encodes:

- monotonic `event_id` sequencing  
- contiguous event ranges per block  
- consistent first/last ID ranges in segment header  

Replay can safely assume:

- events are stored in chronological order  
- block boundaries never break ordering  
- intra-block ordering is strictly increasing  

This enables **fast replay with no sorting or reordering**.

---

# 6. Persistence Properties

The WAL is designed to allow:

### âœ” Zero-copy loading  
Blocks and headers are trivially copyable and binary stable.

### âœ” Fast disk I/O  
- fixed block size  
- 64-byte header alignment  
- minimal CPU overhead  

### âœ” Crash consistency  
At startup, replay:

- rebuilds state from segment 0 â†’ N  
- validates integrity via checksums  
- truncates at first corrupted or partial block  

### âœ” Forward compatibility  
Because all structures are fixed-layout and little-endian.

---

# 7. Replay Pipeline (High-Level)

During restart, the engine performs:

```
for each WAL segment:
    read segment header
    verify header checksums + structure

    for each block in segment:
        read block header
        validate block header + payload checksums
        reapply contained RequestEvents
```

Replay stops safely if corruption is detected.

---

# 8. Linked Documentation

ğŸ“˜ **Detailed Component Docs**

| Component | Description | Link |
|----------|-------------|------|
| **Segment Header** | Metadata for entire WAL segment | [`WAL segment header`](./segment/header.md) |
| **Segment Block** | Block header + event payload | [`WAL segment block`](./segment/block.md) |
| **Block Header** | Metadata for each WAL block | [`WAL segment block_header`](./segment/block_header.md) |
| **Request Events** | Event format persisted in WAL | [`Request event`](../event/request.md) |

---

# 9. Summary

FlashStrikeâ€™s Write-Ahead Log subsystem provides:

- deterministic, replayable event persistence  
- ultra-low-latency binary format  
- strong corruption and tampering detection  
- fixed-size, cache-aligned structures  
- high-throughput append performance  

This architecture is **optimized for matching-engine workloads**, where strict ordering, durability, and replay correctness are essential.

## 10. Related documents
 
`WAL Recorder System` â€” [Overview](./recorder_overview.md)

`WAL Recovery System` â€” [Overview](./recovery_overview.md)

---

ğŸ‘‰ Back to [`FlashStrike â€” High-Performance Matching Engine Documentation`](../../../index.md)
