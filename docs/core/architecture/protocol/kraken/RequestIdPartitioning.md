# Kraken Protocol — Request ID (`req_id`) Partitioning

## Overview

Wirekrak enforces a **strict partitioning of request identifiers (`req_id`)** to preserve
determinism, debuggability, and protocol correctness across control-plane and data-plane
operations.

This partitioning is internal to Core and transparent to users, but it is documented
here to clarify behavior and guarantees.

---

## Design Rationale

Kraken WebSocket interactions mix multiple categories of requests:

- **Control-plane messages** (e.g. `ping`)
- **Subscription management** (subscribe / unsubscribe)
- **Future protocol extensions**

To avoid ambiguity, accidental collisions, or inference-based behavior,
Wirekrak separates these concerns by reserving distinct `req_id` ranges.

This ensures:

- Deterministic ACK correlation
- Clear separation between protocol domains
- Stable replay and recovery behavior
- Easier debugging and trace analysis

---

## `req_id` Ranges

| Range            | Purpose                          |
|------------------|----------------------------------|
| `0`              | **Invalid** (never used)         |
| `1–9`            | Control-plane reserved           |
| `10+`            | Protocol-managed sequence space  |

---

## Control-plane Reservation

The following identifiers are reserved for control-plane traffic:

```cpp
namespace wirekrak::core::protocol::control {

    constexpr std::uint64_t PING_ID        = 1;
    constexpr std::uint64_t PROTOCOL_BASE  = 10;

}
```

- Control-plane messages use **fixed, well-known IDs**
- These IDs are never generated by the protocol sequence
- Control-plane requests are never replayed as subscriptions

---

## Protocol Sequence Behavior

- All subscription and unsubscription requests are assigned `req_id >= PROTOCOL_BASE`
- The internal request ID generator starts at `PROTOCOL_BASE`
- IDs are monotonically increasing
- Replay preserves original `req_id` values

This guarantees that ACKs, rejections, and replay logic always resolve
to the correct protocol operation.

---

## Guarantees

Wirekrak Core guarantees that:

- Control-plane and protocol-plane IDs never collide
- No inference is performed based on missing or reordered ACKs
- Replay logic remains deterministic across reconnects
- Future control-plane extensions remain isolated

---

## Summary

> **Request IDs are partitioned by design.**
>
> Control-plane traffic is explicit and reserved.  
> Protocol traffic is sequenced and replayable.  
> No ambiguity. No inference. No accidental coupling.

This design is foundational to Wirekrak’s correctness and low-latency guarantees.
